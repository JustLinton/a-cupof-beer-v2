---
title: 关于计算机体系结构
date: 2022-06-25 15:13:06
tags: [笔记]
categories: []
summary: 没错，这又是一个期末人的复习生活，2天，一个奇迹，干他！




---

{{< katex >}}

## 计算题

## Ch4

### 基本输入输出方式

Polling：程序控制方式

- 特点
	- 设备由CPU控制，并不具有自主权
	- CPU需要自旋地对设备进行测试以获得设备的工作状态，是否就绪。换言之CPU不能与之并行工作。
	- 数据需要通过CPU
- 过程
	- CPU以自旋的方式不断询问外部设备，其就绪了就进行数据传输（只能传1个字）
	- 可以让CPU按一定的顺序对不同的输出设备进行轮流自旋，形成外部设备优先级

中断方式

- 特点
	- CPU可以和外设并行了，但是数据还是得走CPU

DMA（Direct Memory Access）方式

- 特点
	- 外设可以直接访问内存，数据不走CPU
	- 外设具有自主权，直接向主存发送请求，但是传送的开始和结束需要CPU进行预、后处理
	- DMA控制器包含数据寄存器、地址寄存器、状态寄存器、计数器。数据交换由这些硬件控制
- 过程
	- 设备数据寄存器凑够一个字，就送到MDR；
	- 然后把地址寄存器的地址放到MAR；
	- 计数器-1；如果到0，即可结束，否则重复上述过程。
- 三种DMA方式
	- 周期窃取：在每条指令结束时，CPU测试DMA是否发出请求，如果有，则由CPU来完成DMA过程，例如放到MDR、计数器操作等。缺点是还是在占用CPU时间。
	- 直接存取：DMA直接对Memory发请求。DMA过程完全由硬件实现。缺点是实现困难。
	- 数据块传送：在控制器中加一个非常大的缓冲存储器，然后利用中断方式以数据块为单位传送。

### 中断源分类和优先级

分类

- 外设中断、定时器中断、程序调试断点、故障中断、ALU中断、Memory中断、CU中断、Bus中断
- 可屏蔽中断（一般中断）、不可屏蔽中断（异常中断）
- 通过分类可以便于对不同的中断给予不同的中断入口。当中断发生，可以先找这个入口，再去看具体是该类别下的哪个中断源导致了中断。

优先级

- 中断优先级由硬件排队器决定，服务顺序由软件设置中断屏蔽字决定

### 中断处理过程及其软硬件分配

中断处理过程

- 执行周期结束-硬件关中断-保存硬件现场-撤销中断请求-置屏蔽字-进入中断服务程序入口（保存软件现场）-软件开中断-中断服务-软件关中断-恢复软件现场-恢复屏蔽字-恢复硬件现场-硬件开中断-软件IRET
- 硬件现场是中断屏蔽字、PC、栈帧寄存器、状态字寄存器
- 软件现场：一会要被用到的通用寄存器

软硬件分配的考虑因素

- 响应时间、灵活性
- 硬件实现能确保响应时间，但是灵活性差

### 中断响应时间和服务顺序

中断响应时间的定义

- 从中断请求被提出到其服务程序开始执行

中断响应时间的影响因素

- 最长指令执行时间
- 处理优先级更高的中断所需时间
- 从硬件关中断到软件开中断之间的时间
- 中断服务程序入口寻找所需时间

### 中断屏蔽（设置中断屏蔽位和改变处理机优先级）

【ε】处理机优先级？？？

### 通道处理机的作用和功能

![image-20220626114435208](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626114435208.png)

结构

- 计算机系统中存在很多通道。
- 每个通道都用各自的IO总线连接很多通道处理机。
- 每个通道处理机可以连很多个外设。

作用（意义）

- 进一步解放CPU。因为就算是DMA，也需要CPU去做一些事情。

功能

- CPU请求互动，那么九选择挂在这个通道上的某一个设备与CPU互动
- 执行通道程序（通道程序是CPU指派的）
- 管理外设内部的地址，管理Memory中缓冲区的地址
- 控制外设的数据传送、检查其工作状态、负责传送后处理
- 格式转换（适配）

### 通道处理机的工作过程

三步走

- 用户程序进行系统调用，触发访管中断，进入通道管理程序；CPU指派通道程序，让通道开始工作
- 通道处理机执行通道程序，完成IO控制
- IO结束后，通道发出中断请求，迫使CPU再次进入通道管理程序。（即告诉CPU我干完了）

每完成一次通道IO，CPU只需要调用两次通道管理程序即可。

注意，通道程序位于memory，由设备控制器执行；管理程序位于memory，由CPU执行。

### 通道处理机流量分析

**通道流量.** 即通道的吞吐率，单位时间内可传送的最大数据量。

**通道工作频率.** 通道流量的倒数。

最大通道流量是通道满负荷运转时的流量。如果大于了最大流量，可能出现数据丢失。即以BYTE为例，要求恒有 $f_{BYTE}\leq f_{max.BYTE}$，其他类似。

- 解决数据丢失：增加通道的最大工作流量（流量大了，实际上就是频率快了）、动态改变设备的优先级（眼看着在需要响应的时间点上无法响应，要丢失了，就把它的优先级临时提升从而能够响应）、增加缓冲存储器（为可能发生丢失的设备增加缓冲器，从而把待响应的数据暂存，到了能响应的时候再旧事重提）。

设备的速率与通道流量的关系如下。若fi是us，则单位是MB/s.

- Byte是字节多路通道，Select是选择通道，Block是数组多路通道。fi连接在该通道上的各设备速率，单位B/us（或者说是数据请求间隔的倒数）。

$$
f_{BYTE}=\sum^{P}_{i=1}f_i\\
f_{SELECT}=\max_i\{f_i|i=1,...,p\}\\
f_{BLOCK}=\max_i\{f_i|i=1,...,p\}
$$

通道最大流量的计算公式如下。单位均为B/s。

- n是高速通道一次通信传送的**字节**数。

$$
f_{max.BYTE}=\frac{1}{T_S+T_D}\\
f_{max.SELECT}=\frac{1}{T_S/n+T_D}\\
f_{max.BLOCK}=\frac{1}{T_S/k+T_D}
$$

## Ch5

### 指令的重叠执行方式

指令执行的三个阶段

- 取指
	- 根据PC访存，取到IR
- 分析
	- 操作码译码，根据寻址方式形成物理地址去**取操作数**
- 执行
	- 完成功能，把结果**写回寄存器或存储器**

几种重叠方式

- 不重叠：上一条的执行后面跟着下一条的取指
- 一次重叠：上一条的执行和下一条的取指同时进行。只有阶段1和3会重叠。
- 二次重叠：指令1的执行和指令2的分析和指令3的取指同时执行。阶段123都会重叠。

二次重叠方式的指令执行时间计算

-  总时间\\(T=(2+n)t\\). 其中t是机器周期。因为首尾两个机器周期无法做到完全的三阶段重叠。

二次重叠方式需要解决的问题

- 需要把CPU拆解成取指部件、分析部件、执行部件，从而实现三个阶段的并行
- 需要解决访存冲突问题，因为三个阶段都可能需要访存
	- 法1：低位交叉存取方式可以缓解，而不可以根治
	- 法2：采用指令cache和数据cache分离的“哈佛结构”，并假定操作数和结果都只保存在寄存器中，可以解决该问题
	- 法3：采用先行控制技术

### 先行控制技术的基本结构

![image-20220626155510190](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626155510190.png)

结构：三个控制器，四个缓冲栈

- 存储控制器
- 指令控制器（指令分析器）
- 运算控制器
- 先行指令缓冲栈
	- 实现预取指令。只要它没满，就一直发出取指请求。
	- 为了实现，需要两个PC，分别代表先行的PC值和当前执行的PC值。
	- 分析阶段、执行阶段的实际耗时不相等。
- 先行读数栈
- 先行操作栈
- 后行写数栈

技术要点

- 缓冲技术：用于协调两个工作速率不同的部件。主要实现是缓冲栈。采用缓冲技术可以让运算器专心于数据的运算。
- 预处理技术：

### 流水线的基本原理（时空图）

核心思想

- 空间并行性：操作**部件**相互**独立**
- 时间并行性：对**同一个**操作部件的**不同**部分**分时使用**

![image-20220626162309666](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626162309666.png)

流水寄存器

- 流水线的每个阶段称为流水段（流水步）。
- 在每个流水段的末尾或开头必须设置寄存器，称为流水寄存器，标志流水段的界限。在实际操作上，就是在流水线各部件之间加寄存器（锁存器），数据必须先锁存，从而为下一流水段提供数据源。（否则前一部件一旦进入下一流水段，其输出就改变了，导致本应当输入下一部件的原本的那个输出丢失了。）
- 加入流水寄存器后，指令的执行时间增加。
- 流水寄存器是采用流水线架构后主要需要增加的硬件配置。

流水线的思想

- 因为每条指令的执行都能被分为固定的几个阶段，对于这样的情景，是可以在同一个时刻让负责不同阶段的部件同时工作从而提升效率的。这样就可以近似认为每条指令只需要一个流水段的周期即可执行完成（你竖着看流水线时空图可不就是这样吗）
- 但是，一定要保证流水线不断流，才能实现上述近似。一旦出现断流，就会出现流水线刚开始运作的几个周期（装入时间段），或是流水线快结束的几个周期那样（排空时间段），不能保证每个部件在时刻上都在同时工作。这样就无法达到近似的“一个周期一条指令”的效率。
- 为了保证不断流，需要保证各个阶段花费的时间完全相等。
- 流水线是一种思想，并不是一种特定部件内的结构。任意的满足上述要求的功能需求都可以用流水线的方式进行优化。

![image-20220626162718853](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626162718853.png "Figure. 流水线时空图")

流水线时空图

- 流水线时空图给出了在时刻下，功能部件的被相应的指令使用的情况。

### 流水线的分类（线性流水线和非线性流水线、单功能和多功能流水线、静态和动态流水线）

![image-20220626164715230](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626164715230.png)

![image-20220626165038062](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626165038062.png "Figure. 流水线预约表")

线性与非线性

- 思想：流水段之间是否有信号反馈
- 线性流水线的每个流水段**都流过且仅流过一次**，可用流水线连接图唯一表示
- 非线性流水线的某些流水段之间有反馈回路（即向后方传送信号）或前馈回路（即向前方传送信号），需要使用流水线连接图+流水线预约表共同表示。流水线预约表给出了各流水段在哪些时刻需要被使用。

![image-20220626165338856](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626165338856.png "Figure. 一种多功能流水线。它通过链接不同的流水段功能部件来执行不同功能。")

单功能与多功能

- 单功能流水线：只能完成一种特定功能
- 多功能流水线：各流水段可以通过不同的连接方式实现不同的功能

静态与动态

- 静态流水线：同一段时间内，流水线各段的功能部件只能用固定的方式链接，来实现恒定的功能
- 动态流水线：同一段时间内，流水线各段的功能部件可以动态变换连接方式，实现不同功能之间的并行执行

标量流水线与向量流水线

- 根据数据的表示方式，分成标量流水线与向量流水线。

### 流水线瓶颈的解决

![image-20220626172613899](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626172613899.png)

如图，如果把S2能够拆分成3个长度和其他流水段相同的阶段（S2-1，S2-2，S2-3），那么就可以优化成不带瓶颈的流水线。这需要增加分配器和收集器，如下图，把数据分配到三个部分中，再从三个部分中收集结果，从而实现S2-1，S2-2，S2-3的并行执行。

![image-20220626172746920](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626172746920.png)

### 线性流水线的性能分析（吞吐率、加速比、效率）

#### 吞吐率

$$
N = \frac{n}{T_k}
$$

其中n是指令，Tk是完成这n个指令的总时间。如果假定每个流水段的时间长度完全相等，并且没出现断流，那么完成n个指令的总时间是：
$$
T_k=(k+n-1)t
$$
![image-20220626171959381](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626171959381.png)

t是时钟周期（流水段时间长度），k是流水段段数。可以想象这个公式是因为流水线存在装入时间段和排空时间段而得出的。因为装入阶段和排空阶段能正好**拼成**一个矩形。
$$
N=\frac{n}{(k+n-1)t}
$$
特别地，当n趋近无穷，取得流水线的最大吞吐率。
$$
N_{max}=\lim_{n\rightarrow\inf} \frac{n}{(k+n-1)t}=\frac{1}{t}
$$
换言之，流水线最佳的情况下，一条指令只需要一个时钟周期。这就是流水线当初被提出的思想。

假设有有下面的非均匀流水线，其中S2的时间长度是其他段的3倍。

![image-20220626172115647](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626172115647.png)

仍然采用“拼矩形”思想，矩形的宽度是：
$$
\sum_{i=1}^kt_i
$$
矩形的长度是k，剩下的长度是n-1，每个段的长度由各流水段中最长的段来决定。这个时间最长的段就是流水线的**瓶颈**。综合可知这n条指令需要如下的时间执行完成。
$$
T_n = \sum_{i=1}^kt_i + (n-1)\max (t_1,...,t_k)
$$
于是代入计算即可。特别地，对于最大吞吐率，其结果是取n到无穷。


$$
N=\frac{1}{\max (t_1,...,t_k)}
$$
因此，非均匀流水线的最大吞吐率就是其瓶颈时间长度。

#### 加速比

加速比指执行n条指令，不采用流水线所需的时间和采用流水线所需的时间的比.
$$
S=\frac{T_0}{T_k}
$$
因此直接根据定义：
$$
S=\frac{nkt}{(k+n-1)t}=\frac{nk}{k+n-1}
$$
对于存在瓶颈的流水线，易得：
$$
S=\frac{n\sum^k_{i=1}t_i}{\sum^k_{i=1}t_i+(n-1)\max (t_1,...,t_i)}
$$

#### 效率

效率指执行n条指令，不采用流水线的时空消耗和采用流水线的时空消耗。**所谓时空消耗就是功能部件的数量乘n条指令执行的总时间。**

> 换言之，效率指的是采用流水线后各部件的利用效率。理想流水线的效率是1.

即：
$$
E = \frac{T_0}{T_k\cdot k}
$$
如果不采用流水线，看做只有一个部件。
$$
E=\frac{nkt}{(k+n-1)t\cdot k} = \frac{n}{k+n-1}
$$
对于存在瓶颈的流水线，易得：
$$
S=\frac{n\sum^k_{i=1}t_i}{[\sum^k_{i=1}t_i+(n-1)\max (t_1,...,t_i)]\cdot k}
$$

#### 总结（后三条仅适用于无瓶颈流水线）

随着n的值增大，流水线逐渐趋向于理想流水线，也就是每条指令只需要一个周期即可执行完毕，显然吞吐率、加速比、效率都达到最大，分别是1/t，k，1
$$
T_k' =\sum^k_{i=1}t_i+(n-1)\max (t_1,...,t_i)\\
T_k= (k+n-1)t\\
T_0'=n\sum^k_{i=1}t_i\\
T_0=nkt\\
N=\frac{n}{T_k}=\frac{n}{(k+n-1)t}=\frac{E}{t}\\
S=\frac{T_0}{T_k}=\frac{nk}{k+n-1}=Ek\\
E=\frac{T_0}{T_k\cdot k}=\frac{n}{k+n-1}
$$

#### 速记(仅适用于无瓶颈流水线)

$$
E=\frac{n}{k+n-1}\\
N=\frac{E}{t}\\
S=Ek
$$

### 非线性流水线的调度

问题描述

- 找到一个循环周期，使得按照该周期输入新指令，能够不产生冲突，且吞吐率和效率最高

非线性流水线的表示

- 利用连接图和预约表进行表示。因为连接图不能唯一表示之。
- 一个预约表有多重可能的连接图的对应，一个连接图可以存在多张可能的预约表。

![image-20220626180508158](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626180508158.png)

预约表

- 预约表给出了流水线的逻辑连接结构。行是功能部件，列是流水段。
- 如图是一张预约表，其中每个时间是一个逻辑流水段，而每个这样的流水段可以用到最多四个功能部件。
- 例如在流水段2，需要功能部件S2和S3来完成该段的功能。

重要概念

- 启动距离：连续两个新的指令输入之间的时间间隔（即我们要寻找的周期长度）。体现在图上就是Xi第一次出现的时间和Xi-1第一次出现的时间的差。
- 流水线冲突：几个指令在同一时刻需要用到同样的功能部件。体现在图上就是同一个单元格内有两个不同的Xi。

流水线运转情况

![image-20220626185317098](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626185317098.png)

- 如图，X1是流水线第一次启动（运行第一条输入指令），X2是第二次启动（运行第二条输入指令）。X的下标就代表了这是第几条指令对功能部件的使用。每个启动都是从其启动时间开始，把部件预约表上面的X的排布依次向后搬过来。
- 图中的启动距离是5，也就是第一个X1和第一个X2出现的时间关系是前者+5.

![image-20220626185602445](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626185602445.png)

- 如图，这里的启动距离是3，那么例如单元格(4,S1)，就出现了一个单元格内出现了两个Xi的情况。这就是流水线冲突。

计算题：非线性调度

![image-20220626191246505](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626191246505.png)

- 禁止向量：预约表中任意两个X之间的距离的集合（按行看）。若某一行只有一个X，则不管他。例如上例是S1的4-1，7-4都是3，而7-1是6；S2的5-2也是3；S3的6-2是4.，S4只有一个X，不管他。因此得到禁止向量(3,4,6). 
	- 一定要小心，一行里面可以产生$C_k^2$这种数字。k是这一行的X的个数。
- 初始冲突向量：一个二进制串，$b_ib_{i-1}...b_1$，长度是i，即禁止向量里面的最大值；每一位如果其下标在禁止向量里面存在则是1，否则是0.
	- 例如(3,4,6)的初始冲突向量是(101100).
- 冲突向量：它和初始冲突向量的区别是，后者是流水线刚输入了第一条指令时的冲突向量。后者就指不定是有多少条指令时候的了。**状态图的每个node（状态）都是一个冲突向量。**
- 利用冲突向量逻辑移位判断是否会出现功能段冲突
	- 对于一个冲突向量，如果它向右逻辑移动k位，最后被移除去的是1，那么以k为启动距离就会冲突，否则以k为启动距离就不会冲突。

![image-20220626192156309](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626192156309.png)

- 状态图
	- **状态图的每个node（状态）都是一个冲突向量。**一些启动距离构成了这些状态之间的转换边。
	- 状态图从初始冲突向量开始作为第一个node，然后寻找可以转移的状态（只要是不发生冲突的移位，都可以转移）。
	- 在转移前，首先要计算转移的目的状态。目的状态是移位后的转移前状态的冲突向量和初始冲突向量的OR运算。例如图中101100要通过5转移，那就是移动5位后的000001和初始冲突向量101100做OR，得到101101，也就是目的状态。
	- 转移到的目的状态如果是还没有创建的状态，就创建它。如果是已经存在的，就直接建边指向他。
	- 星号代表**大于等于**。例如101100经过>=7次的移动，变成000000，和初始向量做OR是101100.因为没有转移到新状态，所以只需要建立边。

![image-20220626193104479](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626193104479.png)

![image-20220626193115662](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626193115662.png)

简单循环

- 不经过相同的node的一个圈。
- 注意，只要是碰到了之前已经走过的node，就算是构成了一个圈。最后一个点不算重复。因此上面两种情况都算是简单循环。
- 简单循环使用**其包含的**边的值来记录。例如第一个图是(2,5,7)，第二个图只有（2,5）.

简单循环的平均启动距离

- 即循环内各边的值的和除以不同的值的数量。例如(2,5,7)的是（2+5+7）/3=4.7，（2,5）是(2+5)/2=3.5。一定要注意不是除以边的数量，而是不同的值的数量。

最小启动循环

- 平均启动距离最小的简单循环

最小恒定启动循环

- 只包含一种边值的简单循环，且该简单循环是符合这种条件的简单循环中平均启动距离最小者。

### 全局相关

#### 定义

由于条件转移或程序中断导致的相关。在出现这两种情况时，应当尽量避免流水线的断流及其造成的效率下降。

> 注意：一定是条件转移指令才会导致全局相关。因为无条件转移指令不存在两个不同出口。

#### 条件分支指令在流水线中的执行

![image-20220626200510713](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626200510713.png)

一般情况下，都是先CMP，再Jθ。两条指令都是连着的。如果如图（图中每个方框代表一个流水段），在i-1、i处，两条指令分别进入流水线，且该流水线有k段，那么在i+k-1时Jθ指令执行完成，i+k-2时CMP执行完成。当CMP执行完成时，Jθ才知道是该跳转还是不该跳转。

如果不该跳转，那么一直走上面那个分支就是正确的，对流水线没有效率上的影响；但是如果该跳转，那上面从i+1、i+2一直到i+k-2就都白干了，**需要废除他们的一切效果**，并转而从p开始重新执行。

值得注意的是，效果没有那么好废除。而且如果不能完全废除掉，程序执行就是错误的。例如指令i+1是要改写一些寄存器的值，如果不能全部恢复他们，就寄了。因此可以采用如下两种方案，既然没法恢复，那就干脆啥也别干：

- 有的CPU在转移条件码出现前，不做任何运算操作。
- 有的CPU在转移条件码出现前正常工作，但是不写回。

![image-20220626172613899](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626172613899.png)

怎么算的？还是以这个图为例，每条指令执行完（即处在最后一个流水段）的同时，新一个指令进入流水线（即处在第一个流水段。），图中不管省略号，假设就是6段，那么1到n之间是6-1个跳，即k-1个跳。

#### 条件转移指令的性能指标计算

![image-20220626202124266](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626202124266.png)

如果转移失败，那么流水线上的一切内容全部作废，整个流水线重新**冷启动**。（右1）

观察（左1），可以看到需要k-1个机器周期来使流水线从冷启动状态恢复到满运行状态。因此条件转移成功带来的损失是多了k-1个时钟周期。

因此，带有条件分支指令的流水线总执行时间如下。其中Tk是正常情况下不带分支指令的流水线执行总时间，k是流水线功能段数量，p是条件分支指令占比，q是转移成功的几率。
$$
T_{Jθ}=T_k+npq(k-1)t\\
$$
利用这个新的时间来计算N、E、S即可。

#### 动态分支预测技术

目的

- 记录转移结果（即是否成功）历史记录，及其目的地址或目的地址的前几条指令

把转移结果历史记录在指令cache中

- 指令cache中开辟一个转移历史表。每次有条件转移被执行，就去更新这个表。
- 这个表可以记录最近1次的结果，也可以设计成记录最近2次的。例如最近两次都转移失败才记录“F”，有一次成功就能记录“T”
- 当执行到表项代表的指令时，查表来决定流水线的行为。是装入转移成功后面的指令，还是装入转移失败后面的指令。

![image-20220626204553620](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626204553620.png)

用缓冲栈保存转移指令结果及其目标地址

- 为每条指令都设置自己的转移历史表，并且记录转移目标地址。只不过是存在缓冲栈中。

![image-20220626204707019](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626204707019.png)

用cache保存转移指令结果及其目标地址处的前几条指令

- 和缓冲栈方法一样。只不过把目标地址字段替换成一个存储了转移目标地址处连续的几条指令构成的数组。

#### 静态分支预测技术

- 可以把真出口地址处和假出口地址处都预先取出。
- 转移预测的方向在编译后就是固定的，不存在那种最近转移结果历史来做参照了。
- 可以通过软件实现也可以通过硬件实现。

#### 提前形成条件码

![image-20220626200510713](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220626200510713.png)

思想

- 如图，如果能在CMP指令进入流水线的第一个周期（图中的i-1）就得出条件码，那么就可以直接决定要往那边走，一条多余的指令都无需执行了。

算术运算

- 主要是通过一些算术运算的规则得出，例如正数和负数做乘法肯定是负数。如果这个符号是条件码，就很nice。

把产生条件码与使用条件码的指令分开

- 也就是把CMP指令和Jθ指令通过编译器优化让他们间隔足够远的距离，让图中的i之前，就已经有条件码被计算出来了。
- 这需要专用的条件码寄存器去存储条件码，以防止CMP的结果经过了这么多条指令后被覆盖而丢失。

## Ch6

### 向量处理机基本概念

向量处理机

- 向量处理机是具有向量数据表示和向量指令系统的处理机。
- 一般具有多条并行工作的流水线。
- 必须把问题转换成向量表示才能发挥向量处理机的效率。



### 向量处理机的两种基本结构及其处理方式

### 向量链接技术的基本原理和执行时间的计算

什么情况下可以链接，什么情况下只能分开执行

链接的好处

### 向量循环开采技术

### 向量指令处理时间、最大性能、半性能向量长度、向量长度临界值的计算

（重点）

## Ch7

### 互连网络的作用

- 处理机与其本地存储器的互联网络
- 处理机和外围IO设备的互联网络
- 多处理机情况下，处理机和处理机之间的互联网络
- 多处理机情况下，多个处理机与共享存储器间的互联网络

### 互连函数

- 表示了网络的输入端到输出端的**一一映射**关系。
- 注意，网络的输入端数量和输出端数量**相等**，分别用0,...,n-1表示。
- 对n个端的网络，其互联函数可以表示为长度为log的二进制串的函数。

注意，我们定义第0位是最右边的那个。那么第k位就是从右往左算的。例如1就是0左边那个。

| 函数             | 描述                                                         | 例子                                                         |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 交换函数         | 第k位取反                                                    | $C_2(0010011)=0010111$                                       |
| 均匀洗牌（混洗） | 循环左移1位                                                  | $\sigma(0010111)=0101110\\\sigma_4(0010111)=0011110\\\sigma^4(0010111)=0100111$ |
| 逆混洗           | 循环右移1位                                                  | $\sigma(0010111)=1001011$                                    |
| 蝶式             | 最高位和最低位互换                                           | $\beta(0010111)=1010110\\\beta_4(0010111)=0011110\\\beta^4(0010111)=0010111$ |
| 反位序           | 颠倒二进制位                                                 | $\rho(0010111)=1110100\\\rho_4(0010111)=0011110\\\rho^4(0010111)=0100111$ |
| 移数             | k的符号左加右减，加k的偏移量，出了范围的取模（模的是十进制的编号数量N） | 对于3位的，则N=8，$\begin{cases} k=2，a(1)=3，a(7)=9\%8=1;\\k=-2,a(1)=-1\%8=7,a(7)=5.\end{cases}$ |
| PM2I             | Plus or Minus $2^i$. 分成$2^i$个组，每个组内元素是等差数列，首项是0,1,2,3...这样的，公差是$2^i$. 如果i>0，那么是升序排列，否则降序。然后以每个组为单位，对组内的任意相邻（且循环）两元素前者连向后者。 | 例如N=8（十进制的编号数量N是8），那么$\begin{cases}PM2_{+1}=(0,2,4,6),(1,3,5,7)\\PM2_{-2}=(0,4),(1,5),(2,6),(3,7)\end{cases}$ |

### 互联网络相关八股

#### 重要概念

- 网络规模：包含的结点个数
- 距离：两个结点之间相连的最少边数
- 网络直径：网络中任意两个结点间距离的最大值
- 等分宽度：把由N个节点构成的网络切成节点数相同（N/2）的两半，在各种切法中，沿切口边数的最小值

#### 发送与接受过程

发送方

- 从用户空间复制到系统缓冲区
- 在系统缓冲区打包，并交给网卡
- 网卡发送信息（系统缓冲区-其他设备）

接收方

- 从网卡接收信息（其他设备-系统缓冲区）
- 在系统缓冲区拆包，校验，ACK
- 从系统缓冲区复制到用户空间

特别地，若发送方收到ACK，则系统缓冲区被撤销；若超时则重传。

### 性能评估

- 总时延＝发送方开销＋飞行时间＋ 消息长度/频宽＋接收方开销
- 信号在导体中传递速度大约是光速的50％。因此飞行时间就是距离除以光速的50%。
- 传输时延=飞行时间+传输时间
- 传输时间=信息长度/频宽
- 频宽=信息传递的最大速率
- 飞行时间=从发送第一个bit到第一个bit到达之间的时间间隔

注意，消息大小可能以B为单位给出，但是频宽可能是bit。

### 静态互连网络的基本类型

静态互联网络是连接通路固定不变的网络，在运行时不能修改连接方式。



### 动态互连网络（包括多级立方体网络、Omega 网络）

动态互联网络是连接通路可以在运行时变化的。这种变化由交换开关实现。

![image-20220627115754560](https://linton-pics.oss-cn-beijing.aliyuncs.com/uPic/image-20220627115754560.png)

“播”：broadcasting。即广播📢。

对于网络或开关，所谓$k\times k$，就是k个输入，k个输出。例如8输入的Omega被称为$8\times 8$，开关被称为$2\times 2$。

一个N输入的多级立方体网络或Omega网络都是有 $\log_2N$级，每级是N/2个$2\times 2$开关模块，共需要 $\log_2 N\times N/2$个开关。因此他们画出图后，在形式上没有任何区别。区别是多级立方体是2功能开关，Omega是四功能的。
